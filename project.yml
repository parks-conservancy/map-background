# == Global project settings ===========================================

name:             GGNPC Features
description:      ''
attribution:      'Map Data Â© OpenStreetMap'
bounds:           [-123.640, 36.791, -121.025, 38.719]
center:           [-122.5369, 37.8704, 13]
format:           png
interactivity:    false
minzoom:          10
maxzoom:          20
srs:              '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over'
metatile:         2


# == Layer & Datasource defaults =======================================

_layer_default:   &layer
  'srs-name':     '900913'
  srs:            '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over'

_pg_default:      &postgis
  type:           postgis
  dbname:         {{dbname}}
  host:           {{dbhost}}
  user:           {{dbuser}}
  password:       {{dbpassword}}
  port:           {{dbport}}
  geometry_field: way
  extent:         '-13763541.8416803, 4410014.78335954, -13472441.3732559, 4681500.2899002'
  srs:            '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over'


# == Stylesheets =======================================================

Stylesheet:
  - map.mss
  - roads.mss
  - icons.mss
  - labels.mss


# == Layers ============================================================

Layer:

  # ---- Land areas ----------------------------------------------------

  - <<: *layer
    name: land
    id:   land
    Datasource:
      <<: *postgis
      table: coastline
      geometry_field: geom

  # ---- Protected Areas (CPAD) ----------------------------------------

  - <<: *layer
    name: cpad_units
    id:   cpad_units
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT access_typ AS access_type, geom
          FROM cpad_units
          WHERE geom && !bbox!
        ) AS _

  # ---- GGNRA Boundary ------------------------------------------------

  - <<: *layer
    name: park_units
    id:   park_units
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT goga_man, geom
          FROM park_units
          WHERE geom && !bbox!
            AND goga_man IN ('Yes', 'Trust', 'Offshore')
        ) AS _

  # ---- School (OSM) --------------------------------------------------

  - <<: *layer
    name: school
    id:   school
    status: on
    Datasource:
      <<: *postgis
      table: >
        (
          SELECT way
          FROM planet_osm_polygon
          WHERE way && !bbox!
            AND tags @> 'amenity=>university'
        ) AS school

  # ---- Foreshore (NHD) -----------------------------------------------

  - <<: *layer
    name: foreshore
    id:   foreshore
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
            SELECT ftype, ST_Collect(geom) AS geom
            FROM nhdarea
            WHERE geom && !bbox!
              AND fcode IN (
                36400, -- Foreshore

                 -1
              )
            GROUP BY ftype
        ) AS _

    # ---- Beach (OSM) ---------------------------------------------------

  - <<: *layer
    name: beach
    id:   beach
    status: on
    Datasource:
      <<: *postgis
      table: >
        (
            SELECT way
            FROM planet_osm_polygon
            WHERE way && !bbox!
              AND tags @> 'natural=>beach'
        ) AS beach

  # ---- Sports Fields -------------------------------------------------

  - <<: *layer
    name: fields
    id:   fields
    status: on
    Datasource:
      <<: *postgis
      table: >
        (
        SELECT tags -> 'leisure' leisure, way
        FROM planet_osm_polygon
        WHERE way && !bbox!
        AND tags ? 'leisure'
        AND tags -> 'leisure' IN ('pitch', 'playground', 'stadium', 'recreation_ground', 'court', 'tennis', 'track', 'dog_park', 'golf_course')
          AND zoom(!scale_denominator!) >= 14
        ) AS _

  # ---- Contours ------------------------------------------------------

  # - <<: *layer
  #   name: contour
  #   id:   contour
  #   status: on
  #   Datasource:
  #     <<: *postgis
  #     geometry_field: geom
  #     table: >
  #       (
  #         SELECT geom,
  #         (CASE
  #         WHEN ((elev / 3.048) * 10) % 500 = 0 THEN 500
  #         WHEN ((elev / 3.048) * 10) % 100 = 0 THEN 100
  #         WHEN ((elev / 3.048) * 10) % 50 = 0 THEN 50
  #         WHEN ((elev / 3.048) * 10) % 10 = 0 THEN 10
  #         END) AS int,
  #         elev / 3.048 * 10 AS elev
  #         FROM contour
  #         WHERE geom && !bbox!
  #           AND zoom(!scale_denominator!) >= 14
  #       ) AS _

  # ---- Water (lines) (NHD) -------------------------------------------

  - <<: *layer
    name: water-lines
    id:   water-lines
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT geom
          FROM nhdflowline
          WHERE geom && !bbox!
            AND zoom(!scale_denominator!) >= 14
        ) AS _

  # ---- Water (NHD) ---------------------------------------------------

  - <<: *layer
    name: water
    id:   water
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
            SELECT ftype, ST_Collect(geom) AS geom
            FROM nhdwaterbody
            WHERE geom && !bbox!
              AND fcode IN (
                39000, -- Lake/Pond
                39004, -- Lake/Pond: Hydrographic Category = Perennial
                39009, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Average Water Elevation
                39010, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Normal Pool
                39011, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Date of Photography
                39012, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Spillway Elevation

                43600, -- Reservoir
                43601, -- Reservoir: Reservoir Type = Aquaculture
                43603, -- Reservoir: Reservoir Type = Decorative Pool
                43604, -- Reservoir: Reservoir Type = Tailings Pond; Construction Material = Earthen
                43605, -- Reservoir: Reservoir Type = Tailings Pond
                43606, -- Reservoir: Reservoir Type = Disposal
                43607, -- Reservoir: Reservoir Type = Evaporator
                43608, -- Reservoir: Reservoir Type = Swimming Pool
                43609, -- Reservoir: Reservoir Type = Cooling Pond
                43610, -- Reservoir: Reservoir Type = Filtration Pond
                43611, -- Reservoir: Reservoir Type = Settling Pond
                43612, -- Reservoir: Reservoir Type = Sewage Treatment Pond
                43613, -- Reservoir: Reservoir Type = Water Storage; Construction Material = Nonearthen
                43614, -- Reservoir: Reservoir Type = Water Storage; Construction Material = Earthen; Hydrographic Category = Intermittent
                43615, -- Reservoir: Reservoir Type = Water Storage; Construction Material = Earthen; Hydrographic Category = Perennial
                43617, -- Reservoir: Reservoir Type = Water Storage
                43618, -- Reservoir: Construction Material = Earthen
                43619, -- Reservoir: Construction Material = Nonearthen
                43621, -- Reservoir: Reservoir Type = Water Storage; Hydrographic Category = Perennial
                43623, -- Reservoir: Reservoir Type = Evaporator; Construction Material = Earthen
                43624, -- Reservoir; Reservoir Type = Treatment
                43625, -- Reservoir: Reservoir Type = Disposal; Construction Material = Earthen
                43626, -- Reservoir: Reservoir Type = Disposal; Construction Material = Nonearthen

                46600, -- Swamp/Marsh
                46601, -- Swamp/Marsh: Hydrographic Category = Intermittent
                46602, -- Swamp/Marsh: Hydrographic Category = Perennial

                 -1
              )
            GROUP BY ftype
          UNION
            SELECT ftype, ST_Collect(geom) AS geom
            FROM nhdarea
            WHERE geom && !bbox!
              AND fcode IN (
                33600, -- Canal/Ditch
                33601, -- Canal/Ditch: Canal/Ditch Type = Aqueduct

                44500, -- Sea/Ocean

                45500, -- Spillway

                46000, -- Stream/River
                46006, -- Stream/River: Hydrographic Category = Perennial

                 -1
              )
            GROUP BY ftype
          UNION
            SELECT 445, geom
            FROM water_fill
            WHERE geom && !bbox!
        ) AS _

  # ---- Coastline (NHD) -----------------------------------------------

  - <<: *layer
    name: coastline
    id:   coastline
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT ST_Union(geom) AS geom, SUM(areasqkm) AS areasqkm FROM (
              SELECT geom, areasqkm
              FROM nhdwaterbody
              WHERE geom && !bbox!
                AND fcode IN (
                  39000, -- Lake/Pond
                  39004, -- Lake/Pond: Hydrographic Category = Perennial
                  39009, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Average Water Elevation
                  39010, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Normal Pool
                  39011, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Date of Photography
                  39012, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Spillway Elevation

                  43600, -- Reservoir
                  43601, -- Reservoir: Reservoir Type = Aquaculture
                  43603, -- Reservoir: Reservoir Type = Decorative Pool
                  43604, -- Reservoir: Reservoir Type = Tailings Pond; Construction Material = Earthen
                  43605, -- Reservoir: Reservoir Type = Tailings Pond
                  43606, -- Reservoir: Reservoir Type = Disposal
                  43607, -- Reservoir: Reservoir Type = Evaporator
                  43608, -- Reservoir: Reservoir Type = Swimming Pool
                  43609, -- Reservoir: Reservoir Type = Cooling Pond
                  43610, -- Reservoir: Reservoir Type = Filtration Pond
                  43611, -- Reservoir: Reservoir Type = Settling Pond
                  43612, -- Reservoir: Reservoir Type = Sewage Treatment Pond
                  43613, -- Reservoir: Reservoir Type = Water Storage; Construction Material = Nonearthen
                  43614, -- Reservoir: Reservoir Type = Water Storage; Construction Material = Earthen; Hydrographic Category = Intermittent
                  43615, -- Reservoir: Reservoir Type = Water Storage; Construction Material = Earthen; Hydrographic Category = Perennial
                  43617, -- Reservoir: Reservoir Type = Water Storage
                  43618, -- Reservoir: Construction Material = Earthen
                  43619, -- Reservoir: Construction Material = Nonearthen
                  43621, -- Reservoir: Reservoir Type = Water Storage; Hydrographic Category = Perennial
                  43623, -- Reservoir: Reservoir Type = Evaporator; Construction Material = Earthen
                  43624, -- Reservoir; Reservoir Type = Treatment
                  43625, -- Reservoir: Reservoir Type = Disposal; Construction Material = Earthen
                  43626, -- Reservoir: Reservoir Type = Disposal; Construction Material = Nonearthen

                  -1
                )
            UNION
              SELECT geom, areasqkm
              FROM nhdarea
              WHERE geom && !bbox!
                AND fcode IN (
                  33600, -- Canal/Ditch
                  33601, -- Canal/Ditch: Canal/Ditch Type = Aqueduct

                  44500, -- Sea/Ocean

                  45500, -- Spillway

                  46000, -- Stream/River
                  46006, -- Stream/River: Hydrographic Category = Perennial

                  -1
                )
            UNION
              SELECT geom, 9999
              FROM water_fill
              WHERE geom && !bbox!
          ) AS _
          -- TODO zoom-dependent factor (0.075 makes sense at z14)
          WHERE areasqkm >= 0.075
        ) AS _

  # ---- GGNRA Boundaries (offshore) -----------------------------------

  - <<: *layer
    name: offshore-boundaries
    id:   offshore-boundaries
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT geom
          FROM ggnra_offshore_boundaries
          WHERE geom && !bbox!
            AND zoom(!scale_denominator!) >= 12
        ) AS _

  # ---- Parking Areas -------------------------------------------------

  - <<: *layer
    name: parking
    id:   parking
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT ST_Union(geom) geom
          FROM (
            SELECT geom
            FROM ggnra_parking_areas
            WHERE geom && !bbox!
              AND zoom(!scale_denominator!) >= 15
          UNION
            SELECT geom
            FROM pt_parking_areas
            WHERE geom && !bbox!
              AND zoom(!scale_denominator!) >= 15
          ) AS _
        ) AS _

  # ---- Ferries--------------------------------------------------------

  - <<: *layer
    name: ferry
    id:   ferry
    Datasource:
      <<: *postgis
      table: >
        (
          SELECT way
          FROM planet_osm_line
          WHERE way && !bbox!
            AND tags @> 'route=>ferry'
          ORDER BY z_order ASC
        ) AS _

  # ---- Roads ---------------------------------------------------------

  - <<: *layer
    name: road
    id:   road
    Datasource:
      <<: *postgis
      table: >
        (
          SELECT tags -> 'highway' AS highway,
            tags -> 'aeroway' AS aeroway,
            (CASE
            WHEN tags ? 'bridge' AND tags -> 'bridge' NOT IN ('no', 'false') THEN 'yes'
            ELSE NULL
            END) bridge,
            (CASE
            WHEN tags ? 'tunnel' AND tags -> 'tunnel' NOT IN ('no', 'false') THEN 'yes'
            ELSE NULL
            END) tunnel,
            way
          FROM planet_osm_line
          WHERE way && !bbox!
            AND (
              (zoom(!scale_denominator!) >= 14 AND
                ((tags ? 'highway'
                  AND tags -> 'highway' IN ('motorway', 'trunk', 'primary',
                                            'motorway_link', 'trunk_link', 'primary_link',
                                            'secondary_link', 'tertiary_link',
                                            'secondary', 'tertiary', 'residential',
                                            'unclassified', 'service', 'road')
                  AND
                  (NOT tags ? 'access' OR tags -> 'access' NOT IN ('no', 'false')))
                OR
                (tags ? 'aeroway' AND tags -> 'aeroway' IN ('runway', 'taxiway')))
              )
              OR
              (zoom(!scale_denominator!) >= 11 AND
                ((tags ? 'highway'
                  AND tags -> 'highway' IN ('motorway', 'trunk', 'primary',
                                            'secondary', 'tertiary', 'residential',
                                            'unclassified', 'service', 'road')
                  AND
                  (NOT tags ? 'access' OR tags -> 'access' NOT IN ('no', 'false')))
                OR
                (tags ? 'aeroway' AND tags -> 'aeroway' IN ('runway', 'taxiway')))
              )
              OR
              (zoom(!scale_denominator!) >= 10 AND
                (tags -> 'highway' IN ('motorway', 'trunk', 'primary', 'secondary', 'tertiary')
                  AND
                  (NOT tags ? 'access' OR tags -> 'access' NOT IN ('no', 'false')))
              )
              OR
              (zoom(!scale_denominator!) >= 9 AND
                (tags -> 'highway' IN ('motorway', 'trunk', 'primary')
                  AND
                  (NOT tags ? 'access' OR tags -> 'access' NOT IN ('no', 'false')))
              )
              OR
              (zoom(!scale_denominator!) >= 6 AND
                (tags -> 'highway' IN ('motorway', 'trunk')
                  AND
                  (NOT tags ? 'access' OR tags -> 'access' NOT IN ('no', 'false')))
              )
            )
          ORDER BY z_order ASC
        ) AS _

  # ---- Buildings -----------------------------------------------------

  - <<: *layer
    name: buildings
    id:   buildings
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT geom,
            (CASE
            WHEN name ILIKE 'battery %' THEN true
            ELSE false
            END) battery
          FROM ggnra_buildings
          WHERE geom && !bbox!
            AND zoom(!scale_denominator!) >= 15
        ) AS _

  # ---- Dual Carriageways ---------------------------------------------

  # select s.tags -> 'name', t.tags -> 'name'
  # from planet_osm_line s
  # left join planet_osm_line t
  #   on t.tags -> 'name' = s.tags -> 'name'
  #     AND ST_DWithin(t.way, s.way, 25)
  #     AND ST_Disjoint(t.way, s.way)
  # WHERE t.tags ? 'highway'
  #   AND s.tags ? 'highway'
  #   AND s.tags ? 'name'
  #   AND t.tags ? 'name';

  # - <<: *layer
  #   name: dual-carriageways
  #   id:   dual-carriageways
  #   status: off
  #   Datasource:
  #     <<: *postgis
  #     table: >
  #       ( 
  #       SELECT * FROM (
  #       SELECT tags -> 'name' AS name,
  #         way
  #       FROM planet_osm_line ms
  #       WHERE osm_id IN (
  #           SELECT UNNEST(ids)
  #           FROM (
  #             SELECT ARRAY_AGG(osm_id) AS ids
  #             FROM planet_osm_line
  #             WHERE way && !bbox!
  #               AND tags ?& ARRAY['highway', 'name']
  #               GROUP BY tags -> 'name'
  #               HAVING COUNT(osm_id) > 1
  #           ) AS _
  #         )
  #         AND (
  #           SELECT COUNT(osm_id) AS count
  #           FROM planet_osm_line n
  #           WHERE way && !bbox!
  #             AND tags ? 'highway'
  #             AND tags -> 'name' = ms.tags -> 'name'
  #             AND ST_DWithin(ms.way, n.way, 25)
  #             AND ST_Disjoint(ms.way, n.way)
  #         ) > 1
  #       ORDER BY tags -> 'name'
  #       ) AS _
  #       WHERE zoom(!scale_denominator!) >= 15
  #       ) AS _

  # ---- Trails --------------------------------------------------------

  - <<: *layer
    name: trails
    id:   trails
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT *
          FROM trails
          WHERE geom && !bbox!
            AND zoom(!scale_denominator!) >= 13
        ) AS _

  # ---- GGNRA Unit Names ----------------------------------------------

  - <<: *layer
    name: unit_labels
    id:   unit_labels
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT name, geom
          FROM locations
          WHERE geom && !bbox!
            AND type='Park'
            AND zoom(!scale_denominator!) >= 11
        ) AS _

  # ---- Recreational Opportunities (OSM) ------------------------------

  # - <<: *layer
  #   name: sports
  #   id:   sports
  #   status: off
  #   Datasource:
  #     <<: *postgis
  #     table: >
  #       (
  #         SELECT * FROM (
  #           SELECT COALESCE(tags -> 'sport', tags -> 'leisure') AS sport, way
  #           FROM planet_osm_point
  #           WHERE way && !bbox!
  #             AND tags ?| ARRAY['sport', 'leisure']
  #             AND (
  #               string_to_array(tags -> 'sport', ';') && ARRAY['surfing',
  #                                                              'kiteboarding',
  #                                                              'windsurfing',
  #                                                              'paddleboarding'
  #                                                              'free_flying']
  #               OR
  #               string_to_array(tags -> 'leisure', ';') && ARRAY['fishing'])
  #         UNION
  #           SELECT COALESCE(tags -> 'sport', tags -> 'leisure') AS sport, way
  #           FROM planet_osm_polygon
  #           WHERE way && !bbox!
  #             AND tags ?| ARRAY['sport', 'leisure']
  #             AND (
  #               string_to_array(tags -> 'sport', ';') && ARRAY['surfing',
  #                                                              'kiteboarding',
  #                                                              'windsurfing',
  #                                                              'paddleboarding'
  #                                                              'free_flying']
  #               OR
  #               string_to_array(tags -> 'leisure', ';') && ARRAY['fishing'])
  #         ) AS x
  #       ) AS x

  # ---- GGNPC Locations -----------------------------------------------

  - <<: *layer
    name: locations
    id:   locations
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT * FROM (
            SELECT name, type, geom,
              (CASE
              WHEN type = 'Park' THEN 1
              WHEN type = 'Visitor Center' THEN 2
              WHEN type = 'Trailhead' THEN 3
              WHEN type = 'Site of Interest' THEN 4
              WHEN type = 'Cafe' THEN 5
              WHEN type = 'Overlook' THEN 6
              WHEN type = 'Campground' THEN 8

              WHEN type = 'Beach' THEN 8
              WHEN type = 'Meeting Place' THEN 9
              WHEN type = 'Restroom' THEN 10
              WHEN type = 'Parking Lot' THEN 11
              WHEN type = 'Restoration Site' THEN 12
              WHEN type = 'Access' THEN 13
              WHEN type = 'Building' THEN 14
              WHEN type = 'Water Fountain' THEN 15
              WHEN type = 'Bike Rack' THEN 16
              ELSE 100
              END) AS priority
            FROM locations
            WHERE geom && !bbox!
              AND type NOT IN ('Park')
              AND type IN ('Campground', 'Visitor Center', 'Site of Interest', 'Cafe', 'Overlook', 'Water Fountain', 'Parking Lot')
              AND zoom(!scale_denominator!) >= 14
          UNION
            SELECT name,
              type,
              geom,
              10 AS priority
            FROM ggnra_restrooms
            WHERE geom && !bbox!
              AND type = 'Restroom'
          UNION
            SELECT regexp_replace(name, '(\s-|:)\s+', E'\n') AS name,
              'Trailhead' AS type,
              geom,
              3 AS priority
            FROM trailheads
            WHERE geom && !bbox!
          ) AS _
          WHERE zoom(!scale_denominator!) >= 14
          ORDER BY priority
        ) AS x

  # ---- Trail Labels --------------------------------------------------

  - <<: *layer
    name: trail-labels
    id:   trail-labels
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT *
          FROM trails
          WHERE zoom(!scale_denominator!) >= 14
            AND geom && !bbox!
        ) AS _

  # ---- Battery Labels ------------------------------------------------

  - <<: *layer
    name: battery-labels
    id:   battery-labels
    status: on
    Datasource:
      <<: *postgis
      geometry_field: geom
      table: >
        (
          SELECT name, geom
          FROM ggnra_buildings
          WHERE geom && !bbox!
            AND name ILIKE 'battery %'
            AND zoom(!scale_denominator!) >= 18
        ) AS _

  # ---- Lighthouses ---------------------------------------------------

  # - <<: *layer
  #   name: lighthouses
  #   id:   lighthouses
  #   status: off
  #   Datasource:
  #     <<: *postgis
  #     table: >
  #       (
  #         SELECT tags -> 'name', way
  #         FROM planet_osm_point
  #         WHERE way && !bbox!
  #           AND tags @> 'man_made=>lighthouse'
  #           AND zoom(!scale_denominator!) >= 14
  #       ) AS _

  # ---- Places --------------------------------------------------------

  - <<: *layer
    name: places
    id:   places
    status: on
    Datasource:
      <<: *postgis
      table: >
        (
          SELECT *
          FROM 
          (
            SELECT DISTINCT ON (name) name, way, place, population,
                   priority, size
            FROM
            (
              SELECT (string_to_array(tags -> 'name', ';'))[1] AS name,
                     way,
                     tags -> 'place' AS place,
                     COALESCE(replace(tags -> 'population', ',', '')::numeric, 0) AS population,
                     CASE
                      WHEN tags -> 'place' IN ('city') THEN 1
                      WHEN tags -> 'place' IN ('suburb') THEN 2
                      WHEN tags -> 'place' IN ('town') THEN 3
                      WHEN tags -> 'place' IN ('neighbourhood') THEN 4
                      WHEN tags -> 'place' IN ('village') THEN 5
                      ELSE 10
                    END AS priority,
                    1 as size
              FROM planet_osm_point
              WHERE way && !bbox!
                AND tags ?& ARRAY['name', 'place']
                AND tags -> 'name' NOT LIKE '%Home%'
                AND tags -> 'name' NOT LIKE '%Trailer Court%'
                AND tags -> 'name' NOT IN ('Doelger City')
                AND NOT tags ? 'historic'
                AND (
                  (
                    zoom(!scale_denominator!) <= 12
                    AND tags -> 'place' IN ('city','town')
                  )
                  OR (
                    zoom(!scale_denominator!) > 12
                    -- island is intentionally omitted
                    AND tags -> 'place' IN ('city','town','village','suburb','neighbourhood','hamlet','islet','locale','locality')
                  )
                )
            UNION
              SELECT (string_to_array(tags -> 'name', ';'))[1] AS name,
                     way,
                     tags -> 'place' AS place,
                     way_area size,
              COALESCE(replace(tags -> 'population', ',', '')::numeric, 0) AS population,
              CASE
                WHEN tags->'place' IN ('city') THEN 1
                WHEN tags->'place' IN ('suburb') THEN 2
                WHEN tags->'place' IN('town') THEN 3
                WHEN tags->'place' IN ('neighbourhood') THEN 4
                WHEN tags->'place' IN ('village') THEN 5
                ELSE 10
              END AS priority
              FROM planet_osm_polygon
              WHERE way && !bbox!
                AND tags ?& ARRAY['name', 'place']
                AND tags -> 'name' NOT LIKE '%Home%'
                AND tags -> 'name' NOT LIKE '%Trailer Court%'
                AND (
                  (
                    zoom(!scale_denominator!) <= 12
                    AND tags -> 'place' IN ('city','town','village')
                  )
                  OR (
                    -- island is intentionally omitted
                    zoom(!scale_denominator!) > 12
                    AND tags -> 'place' IN ('city','town','village','suburb','neighbourhood','hamlet','islet','locale','locality')
                  )
                )
            ) AS stuff
            ORDER BY name
          ) AS stuff
          ORDER BY priority ASC, population DESC, size DESC
        ) AS places

  # ---- CPAD Labels ---------------------------------------------------

  # - <<: *layer
  #   name: cpad-labels
  #   id:   cpad-labels
  #   status: off
  #   Datasource:
  #     <<: *postgis
  #     geometry_field: geom
  #     table: >
  #       (
  #         SELECT unit_name AS name, gis_acres, geom
  #         FROM cpad_superunits
  #         WHERE geom && !bbox!
  #           AND unit_name IS NOT NULL
  #           AND gis_acres > 5
  #         ORDER BY gis_acres DESC
  #       ) AS cpad

  # ---- Water Labels --------------------------------------------------

  # - <<: *layer
  #   name: water-labels
  #   id:   water-labels
  #   status: off
  #   Datasource:
  #     <<: *postgis
  #     geometry_field: geom
  #     table: >
  #       (
  #         SELECT * FROM (
  #           SELECT gnis_name AS name, ftype, geom, areasqkm
  #           FROM nhdwaterbody
  #           WHERE geom && !bbox!
  #             AND gnis_name IS NOT NULL
  #             AND ftype IN (
  #               39000, -- Lake/Pond
  #               39004, -- Lake/Pond: Hydrographic Category = Perennial
  #               39009, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Average Water Elevation
  #               39010, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Normal Pool
  #               39011, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Date of Photography
  #               39012, -- Lake/Pond: Hydrographic Category = Perennial; Stage = Spillway Elevation

  #               43600, -- Reservoir
  #               43601, -- Reservoir: Reservoir Type = Aquaculture
  #               43603, -- Reservoir: Reservoir Type = Decorative Pool
  #               43604, -- Reservoir: Reservoir Type = Tailings Pond; Construction Material = Earthen
  #               43605, -- Reservoir: Reservoir Type = Tailings Pond
  #               43606, -- Reservoir: Reservoir Type = Disposal
  #               43607, -- Reservoir: Reservoir Type = Evaporator
  #               43608, -- Reservoir: Reservoir Type = Swimming Pool
  #               43609, -- Reservoir: Reservoir Type = Cooling Pond
  #               43610, -- Reservoir: Reservoir Type = Filtration Pond
  #               43611, -- Reservoir: Reservoir Type = Settling Pond
  #               43612, -- Reservoir: Reservoir Type = Sewage Treatment Pond
  #               43613, -- Reservoir: Reservoir Type = Water Storage; Construction Material = Nonearthen
  #               43614, -- Reservoir: Reservoir Type = Water Storage; Construction Material = Earthen; Hydrographic Category = Intermittent
  #               43615, -- Reservoir: Reservoir Type = Water Storage; Construction Material = Earthen; Hydrographic Category = Perennial
  #               43617, -- Reservoir: Reservoir Type = Water Storage
  #               43618, -- Reservoir: Construction Material = Earthen
  #               43619, -- Reservoir: Construction Material = Nonearthen
  #               43621, -- Reservoir: Reservoir Type = Water Storage; Hydrographic Category = Perennial
  #               43623, -- Reservoir: Reservoir Type = Evaporator; Construction Material = Earthen
  #               43624, -- Reservoir; Reservoir Type = Treatment
  #               43625, -- Reservoir: Reservoir Type = Disposal; Construction Material = Earthen
  #               43626, -- Reservoir: Reservoir Type = Disposal; Construction Material = Nonearthen

  #               46600, -- Swamp/Marsh
  #               46601, -- Swamp/Marsh: Hydrographic Category = Intermittent
  #               46602, -- Swamp/Marsh: Hydrographic Category = Perennial

  #                -1
  #             )
  #         UNION
  #           SELECT gnis_name AS name, ftype, geom, areasqkm
  #           FROM nhdarea
  #           WHERE geom && !bbox!
  #             AND gnis_name IS NOT NULL
  #             AND ftype IN (
  #               33600, -- Canal/Ditch
  #               33601, -- Canal/Ditch: Canal/Ditch Type = Aqueduct

  #               36400, -- Foreshore

  #               45500, -- Spillway

  #               46000, -- Stream/River
  #               46006, -- Stream/River: Hydrographic Category = Perennial

  #                -1
  #             )
  #         ) AS water
  #         ORDER BY areasqkm DESC
  #       ) AS labels

  # ---- Bay Labels ----------------------------------------------------

  - <<: *layer
    name: bay
    id:   bay
    status: on
    Datasource:
      <<: *postgis
      table: >
        (
          SELECT tags -> 'name' AS name, way
          FROM planet_osm_point
          WHERE way && !bbox!
            AND tags @> 'natural=>bay'
            AND tags ? 'name'
            AND (zoom(!scale_denominator!) >= 13
              OR tags -> 'name' IN ('San Pablo Bay', 'San Francisco Bay', 'Gulf of the Farallones')
            )
        ) AS bay

  # ---- Road Labels ---------------------------------------------------

  - <<: *layer
    name: highway-labels
    id:   highway-labels
    status: on
    Datasource:
      <<: *postgis
      table: >
        (
          SELECT tags -> 'highway' AS highway,
            (string_to_array(tags -> 'name', ';'))[1] AS name,
            way,
            (CASE
            WHEN tags -> 'highway' IN ('motorway') THEN 1
            WHEN tags -> 'highway' IN ('trunk') THEN 2
            WHEN tags -> 'highway' IN ('primary') THEN 3
            WHEN tags -> 'highway' IN ('secondary') THEN 4
            WHEN tags -> 'highway' IN ('tertiary') THEN 5
            WHEN tags -> 'highway' IN ('residential', 'unclassified', 'service', 'road') THEN 6
            ELSE 100
            END) priority
          FROM planet_osm_line
          WHERE way && !bbox!
            AND (
              (zoom(!scale_denominator!) >= 14 AND
               tags -> 'highway' IN ('motorway', 'trunk', 'primary',
                                    'secondary', 'tertiary', 'residential',
                                    'unclassified', 'service', 'road')
              )
              OR
              tags -> 'highway' IN ('motorway', 'trunk', 'primary')
            )
            AND (NOT tags ? 'access' OR tags -> 'access' NOT IN ('no', 'false'))
            AND NOT tags ?| ARRAY['bridge', 'tunnel']
          ORDER BY priority ASC
        ) AS _

